<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peer-to-Peer API Experiment</title>
    <meta name="description" content="Une exp√©rience technique sur les APIs d√©centralis√©es fonctionnant de pair-√†-pair directement dans le navigateur.">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåê</text></svg>">

    <style>
        :root {
            --background: #1a1a1a;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --surface: #2a2a2a;
            --surface-light: #333333;
            --border: #3a3a3a;
            --success: #22c55e;
            --error: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.7;
            padding: 1rem;
        }

        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 1.5rem;
        }

        h1 { font-size: 1.75rem; font-weight: 600; margin-bottom: 0.5rem; }
        header p { color: var(--text-secondary); font-size: 1rem; }

        .tutorial {
            background-color: var(--surface-light);
            border: 1px solid var(--accent);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2.5rem;
        }
        .tutorial h3 { font-size: 1.2rem; color: var(--accent); margin-bottom: 1rem; }
        .tutorial p { color: var(--text-secondary); margin-bottom: 0.5rem; }
        .tutorial strong { color: var(--text-primary); font-weight: 600; }
        .tutorial code { background: var(--background); padding: 2px 6px; border-radius: 4px; font-family: 'SF Mono', 'Consolas', monospace; }

        .section { margin-bottom: 2.5rem; }
        .section h2 { font-size: 1.25rem; margin-bottom: 0.5rem; color: var(--accent); border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }
        .section > p { margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.9rem; }

        .control-group { margin-bottom: 1rem; position: relative; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary); }

        input, textarea, button {
            font-family: inherit;
            font-size: 1rem;
            width: 100%;
            padding: 0.75rem;
            border-radius: 6px;
            border: 1px solid var(--border);
            background-color: var(--background);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        input:focus, textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); }
        textarea { min-height: 120px; resize: vertical; font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace; font-size: 0.9rem; }
        
        button { background-color: var(--accent); color: white; border: none; cursor: pointer; font-weight: 600; margin-top: 1rem; }
        button:hover:not(:disabled) { background-color: var(--accent-hover); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .example-btn {
            background: none;
            border: 1px solid var(--accent);
            color: var(--accent);
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            position: absolute;
            top: 0;
            right: 0;
            width: auto;
            margin: 0;
        }
        .example-btn:hover:not(:disabled) { background-color: rgba(59, 130, 246, 0.1); }

        .log-container { background-color: #111; border: 1px solid var(--border); border-radius: 6px; padding: 1rem; height: 300px; overflow-y: auto; font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace; font-size: 0.85rem; color: var(--text-secondary); }
        .log-line { line-height: 1.5; white-space: pre-wrap; word-break: break-all; }
        .log-line.success { color: var(--success); }
        .log-line.error { color: var(--error); }
        .log-line.info { color: var(--accent); }

        footer { text-align: center; margin-top: 3rem; padding-top: 1rem; border-top: 1px solid var(--border); color: var(--text-secondary); font-size: 0.9rem; }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Exp√©rience d'API P2P</h1>
            <p>Un prototype explorant les APIs d√©centralis√©es dans le navigateur.</p>
        </header>

        <main>
            <div class="tutorial">
                <h3>üí° Comment Tester</h3>
                <p>1. **Initialisez le Pair** : Cliquez sur le premier bouton pour vous connecter au r√©seau P2P.</p>
                <p>2. **Simulez un autre utilisateur** : <strong>Ouvrez cette m√™me page dans un nouvel onglet</strong> ou une nouvelle fen√™tre de navigateur.</p>
                <p>3. **D√©finissez et Interrogez** : D√©finissez une API dans un onglet, et interrogez-la depuis l'autre. Observez la console pour voir la communication directe entre les deux onglets.</p>
            </div>

            <section class="section">
                <h2>1. Connexion au R√©seau</h2>
                <p>Chaque visiteur devient un "pair" sur le r√©seau. L'initialisation est la premi√®re √©tape pour commencer √† communiquer.</p>
                <div class="control-group">
                    <label>Statut : <span id="status">D√©connect√©</span></label>
                    <button id="initBtn" onclick="initPeer()">Initialiser le Pair</button>
                </div>
            </section>

            <section class="section">
                <h2>2. D√©finir un Endpoint d'API</h2>
                <p>Cr√©ez un "endpoint" qui sera disponible pour les autres pairs sur le r√©seau. La logique est une simple fonction Javascript.</p>
                <div class="control-group">
                    <label for="endpointPath">Chemin de l'Endpoint (ex: /products)</label>
                    <button class="example-btn" onclick="loadDefineExample()">Utiliser un exemple</button>
                    <input type="text" id="endpointPath" placeholder="/users">
                </div>
                <div class="control-group">
                    <label for="endpointLogic">Logique de l'Endpoint (doit retourner un objet)</label>
                    <textarea id="endpointLogic" placeholder="() => ({ id: 1, name: 'Alice' })"></textarea>
                </div>
                <button id="defineBtn" onclick="defineApi()" disabled>Annoncer l'Endpoint sur le R√©seau</button>
            </section>

            <section class="section">
                <h2>3. Interroger le R√©seau</h2>
                <p>Appelez un endpoint d√©fini par un autre pair. Si vous testez avec deux onglets, appelez ici l'API que vous avez d√©finie dans l'autre onglet.</p>
                <div class="control-group">
                    <label for="requestPath">Chemin de l'API √† appeler</label>
                    <button class="example-btn" onclick="loadRequestExample()">Utiliser un exemple</button>
                    <input type="text" id="requestPath" placeholder="/api/welcome">
                </div>
                 <button id="requestBtn" onclick="makeRequest()" disabled>Interroger l'Endpoint</button>
            </section>
            
             <section class="section">
                <h2>Comment √ßa fonctionne ?</h2>
                <p>Ce prototype utilise <strong>Gun.js</strong>, une base de donn√©es d√©centralis√©e, pour cr√©er un r√©seau de communication <strong>pair-√†-pair (P2P)</strong> via WebRTC. Il n'y a pas de serveur central. Les donn√©es et les APIs sont partag√©es directement entre les navigateurs des utilisateurs connect√©s. Les donn√©es sont √©ph√©m√®res et n'existent que tant qu'au moins un pair est en ligne.</p>
            </section>

            <section class="section">
                <h2>Console d'√âv√©nements</h2>
                <div id="log" class="log-container"></div>
            </section>
        </main>
        
        <footer>
            <p>&copy; 2025 - Un projet exp√©rimental.</p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>

    <script>
        class PeerService {
            // ... (le code de la classe PeerService reste identique √† la version pr√©c√©dente)
            constructor(logCallback) {
                this.gun = null;
                this.log = logCallback;
                this.endpoints = new Map();
                this.isInitialized = false;
            }

            async initialize() {
                if (this.isInitialized) return;
                
                this.log('info', 'Initialisation du pair...');
                this.gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
                
                this.gun.on('hi', peer => { this.log('success', `Connect√© au pair.`); });
                this.gun.on('bye', peer => { this.log('error', `Pair d√©connect√©.`); });

                this.isInitialized = true;
                this.log('success', 'Initialisation termin√©e. Pr√™t √† communiquer.');
                
                this.listenForRequests();
                
                // Par d√©faut, chaque pair d√©finit une API de bienvenue
                this.defineEndpoint('/api/welcome', () => ({
                    message: "Bienvenue sur le r√©seau P2P!",
                    peerId: this.gun._.opt.pid.substr(0, 12) + '...'
                }));
            }

            defineEndpoint(path, handlerFn) {
                if (!this.isInitialized) throw new Error("Le service n'est pas initialis√©.");
                this.log('info', `D√©finition locale de l'endpoint : ${path}`);
                this.endpoints.set(path, handlerFn);
                this.gun.get('endpoints').get(path).put({ available: true, peerId: this.gun._.opt.pid });
                this.log('success', `Endpoint ${path} annonc√© sur le r√©seau.`);
            }

            listenForRequests() {
                this.gun.get('requests').map().on(async (req, reqId) => {
                    if (!req || !this.endpoints.has(req.path)) return;
                    
                    this.log('info', `Requ√™te re√ßue pour ${req.path}`);
                    
                    try {
                        const handler = this.endpoints.get(req.path);
                        const result = await handler();
                        
                        this.gun.get('responses').get(reqId).put({
                            status: 'success',
                            data: JSON.stringify(result),
                            from: this.gun._.opt.pid
                        });
                        this.log('success', `R√©ponse envoy√©e pour ${req.path}`);
                    } catch (e) {
                        this.gun.get('responses').get(reqId).put({ status: 'error', message: e.message, from: this.gun._.opt.pid });
                        this.log('error', `Erreur en traitant ${req.path}: ${e.message}`);
                    }
                });
            }

            async request(path) {
                if (!this.isInitialized) throw new Error("Le service n'est pas initialis√©.");

                return new Promise((resolve, reject) => {
                    const requestId = Gun.text.random();
                    let timeout;
                    
                    this.log('info', `Envoi de la requ√™te pour ${path}`);

                    const responseNode = this.gun.get('responses').get(requestId);
                    responseNode.on((res) => {
                        if (res) {
                            responseNode.off();
                            clearTimeout(timeout);
                            
                            if(res.status === 'success'){
                                this.log('success', `R√©ponse re√ßue pour ${path}.`);
                                resolve(JSON.parse(res.data));
                            } else {
                                this.log('error', `Erreur re√ßue pour ${path}: ${res.message}`);
                                reject(new Error(res.message));
                            }
                        }
                    });

                    this.gun.get('requests').get(requestId).put({ path: path, from: this.gun._.opt.pid });
                    
                    timeout = setTimeout(() => {
                        responseNode.off();
                        this.log('error', `Timeout: Aucune r√©ponse pour ${path}`);
                        reject(new Error(`La requ√™te pour ${path} a expir√©.`));
                    }, 10000);
                });
            }
        }
        
        // --- Logique de l'interface utilisateur ---
        
        const logEl = document.getElementById('log');
        
        function writeToLog(type, message) {
            const line = document.createElement('div');
            line.className = `log-line ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            line.textContent = `[${timestamp}] ${message}`;
            logEl.appendChild(line);
            logEl.scrollTop = logEl.scrollHeight;
        }

        const peerService = new PeerService(writeToLog);

        async function initPeer() {
            const btn = document.getElementById('initBtn');
            btn.disabled = true;
            btn.textContent = 'Initialisation...';
            try {
                await peerService.initialize();
                document.getElementById('status').textContent = 'Connect√©';
                document.getElementById('status').style.color = 'var(--success)';
                btn.textContent = 'Initialis√©';
                document.getElementById('defineBtn').disabled = false;
                document.getElementById('requestBtn').disabled = false;
            } catch (e) {
                writeToLog('error', `√âchec de l'initialisation: ${e.message}`);
                btn.disabled = false;
                btn.textContent = 'R√©essayer';
            }
        }
        
        function defineApi() {
            const path = document.getElementById('endpointPath').value;
            const logic = document.getElementById('endpointLogic').value;
            
            if (!path || !logic) {
                writeToLog('error', 'Le chemin et la logique sont requis.');
                return;
            }

            try {
                const handler = new Function(`return ${logic}`)();
                peerService.defineEndpoint(path, handler);
            } catch (e) {
                writeToLog('error', `Erreur de syntaxe dans la logique JS : ${e.message}`);
            }
        }

        async function makeRequest() {
            const path = document.getElementById('requestPath').value;
            if (!path) {
                writeToLog('error', 'Le chemin de la requ√™te est requis.');
                return;
            }

            const btn = document.getElementById('requestBtn');
            btn.disabled = true;

            try {
                const data = await peerService.request(path);
                writeToLog('success', `Donn√©es re√ßues pour ${path}: ${JSON.stringify(data, null, 2)}`);
            } catch (e) {
                writeToLog('error', `√âchec de la requ√™te: ${e.message}`);
            } finally {
                btn.disabled = false;
            }
        }

        function loadDefineExample() {
            document.getElementById('endpointPath').value = '/products';
            document.getElementById('endpointLogic').value = `() => ([
    { id: 'prod_1', name: 'Clavier M√©canique', price: 99.99 },
    { id: 'prod_2', name: 'Souris Ergonomique', price: 59.50 }
])`;
            writeToLog('info', 'Exemple de d√©finition d\'API charg√©.');
        }

        function loadRequestExample() {
            document.getElementById('requestPath').value = '/api/welcome';
            writeToLog('info', 'Exemple de requ√™te charg√©. Appelez cette API depuis un autre onglet!');
        }

    </script>
</body>
</html>