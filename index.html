<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peer-to-Peer API Experiment</title>
    <meta name="description" content="Une exp√©rience technique sur les APIs d√©centralis√©es fonctionnant de pair-√†-pair directement dans le navigateur.">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåê</text></svg>">

    <style>
        :root {
            --background: #1a1a1a;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --surface: #2a2a2a;
            --border: #3a3a3a;
            --success: #22c55e;
            --error: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.7;
            padding: 1rem;
        }

        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 1rem;
        }

        h1 {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        header p {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .section {
            margin-bottom: 2.5rem;
        }

        h2 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: var(--accent);
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
        }
        
        .control-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        input, textarea, button {
            font-family: inherit;
            font-size: 1rem;
            width: 100%;
            padding: 0.75rem;
            border-radius: 6px;
            border: 1px solid var(--border);
            background-color: var(--background);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        
        textarea {
            min-height: 120px;
            resize: vertical;
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 0.9rem;
        }

        button {
            background-color: var(--accent);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            margin-top: 1rem;
        }
        
        button:hover:not(:disabled) {
            background-color: var(--accent-hover);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .log-container {
            background-color: #111;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 1rem;
            height: 300px;
            overflow-y: auto;
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .log-line {
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .log-line.success { color: var(--success); }
        .log-line.error { color: var(--error); }
        .log-line.info { color: var(--accent); }

        footer {
            text-align: center;
            margin-top: 3rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Exp√©rience d'API P2P</h1>
            <p>Un prototype explorant les APIs d√©centralis√©es dans le navigateur.</p>
        </header>

        <main>
            <section class="section">
                <h2>1. Connexion au R√©seau</h2>
                <div class="control-group">
                    <label>Statut : <span id="status">D√©connect√©</span></label>
                    <button id="initBtn" onclick="initPeer()">Initialiser le Pair</button>
                </div>
            </section>

            <section class="section">
                <h2>2. D√©finir un Endpoint d'API</h2>
                <div class="control-group">
                    <label for="endpointPath">Chemin de l'Endpoint (ex: /users)</label>
                    <input type="text" id="endpointPath" placeholder="/users">
                </div>
                <div class="control-group">
                    <label for="endpointLogic">Logique de l'Endpoint (fonction JS)</label>
                    <textarea id="endpointLogic" placeholder="() => ({ id: 1, name: 'Alice' })"></textarea>
                </div>
                <button id="defineBtn" onclick="defineApi()" disabled>D√©finir l'Endpoint</button>
            </section>

            <section class="section">
                <h2>3. Interroger le R√©seau</h2>
                <div class="control-group">
                    <label for="requestPath">Chemin de l'API √† appeler</label>
                    <input type="text" id="requestPath" placeholder="/users">
                </div>
                 <button id="requestBtn" onclick="makeRequest()" disabled>Interroger l'Endpoint</button>
            </section>
            
            <section class="section">
                <h2>Console d'√âv√©nements</h2>
                <div id="log" class="log-container"></div>
            </section>
        </main>
        
        <footer>
            <p>&copy; 2025 - Un projet exp√©rimental.</p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>

    <script>
        // --- Service P2P - Version Fonctionnelle et Discr√®te ---

        class PeerService {
            constructor(logCallback) {
                this.gun = null;
                this.log = logCallback;
                this.endpoints = new Map();
                this.isInitialized = false;
            }

            async initialize() {
                if (this.isInitialized) return;
                
                this.log('info', 'Initialisation du pair...');
                // Utilise des relais publics pour la d√©couverte de pairs (gratuit)
                this.gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
                
                this.gun.on('hi', peer => {
                    this.log('success', `Connect√© au pair : ${peer.id || 'inconnu'}`);
                });

                this.gun.on('bye', peer => {
                    this.log('error', `Pair d√©connect√© : ${peer.id || 'inconnu'}`);
                });

                this.isInitialized = true;
                this.log('success', 'Initialisation termin√©e. Pr√™t √† communiquer.');
                
                // √âcouter les requ√™tes entrantes
                this.listenForRequests();
            }

            defineEndpoint(path, handlerFn) {
                if (!this.isInitialized) throw new Error("Le service n'est pas initialis√©.");
                this.log('info', `D√©finition locale de l'endpoint : ${path}`);
                
                // Stocker la fonction gestionnaire localement
                this.endpoints.set(path, handlerFn);

                // Annoncer la disponibilit√© de cet endpoint sur le r√©seau
                this.gun.get('endpoints').get(path).put({ available: true, peerId: this.gun._.opt.pid });
                this.log('success', `Endpoint ${path} annonc√© sur le r√©seau.`);
            }

            listenForRequests() {
                this.gun.get('requests').map().on(async (req, reqId) => {
                    if (!req || !this.endpoints.has(req.path)) {
                        return;
                    }
                    
                    // Une requ√™te nous est destin√©e
                    this.log('info', `Requ√™te re√ßue pour ${req.path} (ID: ${reqId})`);
                    
                    try {
                        const handler = this.endpoints.get(req.path);
                        const result = await handler();
                        
                        // R√©pondre sur le canal de r√©ponse
                        this.gun.get('responses').get(reqId).put({
                            status: 'success',
                            data: JSON.stringify(result),
                            from: this.gun._.opt.pid
                        });
                        this.log('success', `R√©ponse envoy√©e pour ${req.path}`);
                    } catch (e) {
                        this.gun.get('responses').get(reqId).put({
                            status: 'error',
                            message: e.message,
                            from: this.gun._.opt.pid
                        });
                        this.log('error', `Erreur en traitant la requ√™te pour ${req.path}: ${e.message}`);
                    }
                });
            }

            async request(path) {
                if (!this.isInitialized) throw new Error("Le service n'est pas initialis√©.");

                return new Promise((resolve, reject) => {
                    const requestId = Gun.text.random();
                    let timeout;
                    
                    this.log('info', `Envoi de la requ√™te pour ${path} (ID: ${requestId})`);

                    // √âcouter la r√©ponse
                    const responseNode = this.gun.get('responses').get(requestId);
                    responseNode.on((res, key) => {
                        if (res) {
                            // Une fois la r√©ponse re√ßue, on arr√™te d'√©couter et on nettoie.
                            responseNode.off();
                            clearTimeout(timeout);
                            
                            if(res.status === 'success'){
                                this.log('success', `R√©ponse re√ßue pour ${path} de ${res.from}`);
                                resolve(JSON.parse(res.data));
                            } else {
                                this.log('error', `Erreur re√ßue pour ${path}: ${res.message}`);
                                reject(new Error(res.message));
                            }
                        }
                    });

                    // Envoyer la requ√™te
                    this.gun.get('requests').get(requestId).put({ path: path, from: this.gun._.opt.pid });
                    
                    // Timeout de la requ√™te
                    timeout = setTimeout(() => {
                        responseNode.off();
                        this.log('error', `Timeout: Aucune r√©ponse pour ${path}`);
                        reject(new Error(`La requ√™te pour ${path} a expir√©.`));
                    }, 10000); // 10 secondes
                });
            }
        }

        // --- Logique de l'interface utilisateur ---
        
        const logEl = document.getElementById('log');
        
        function writeToLog(type, message) {
            const line = document.createElement('div');
            line.className = `log-line ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            line.textContent = `[${timestamp}] ${message}`;
            logEl.appendChild(line);
            logEl.scrollTop = logEl.scrollHeight;
        }

        const peerService = new PeerService(writeToLog);

        async function initPeer() {
            const btn = document.getElementById('initBtn');
            btn.disabled = true;
            btn.textContent = 'Initialisation...';
            try {
                await peerService.initialize();
                document.getElementById('status').textContent = 'Connect√©';
                document.getElementById('status').style.color = 'var(--success)';
                btn.textContent = 'Initialis√©';
                
                // Activer les autres boutons
                document.getElementById('defineBtn').disabled = false;
                document.getElementById('requestBtn').disabled = false;
            } catch (e) {
                writeToLog('error', `√âchec de l'initialisation: ${e.message}`);
                btn.disabled = false;
                 btn.textContent = 'R√©essayer';
            }
        }
        
        function defineApi() {
            const path = document.getElementById('endpointPath').value;
            const logic = document.getElementById('endpointLogic').value;
            
            if (!path || !logic) {
                writeToLog('error', 'Le chemin et la logique de l'endpoint sont requis.');
                return;
            }

            try {
                // IMPORTANT: Dans un vrai produit, 'eval' est dangereux.
                // Ici, c'est une mani√®re de rendre la d√©mo interactive.
                // On encapsule la logique dans une fonction pour l'ex√©cuter plus tard.
                const handler = new Function(`return ${logic}`)();
                
                peerService.defineEndpoint(path, handler);
                document.getElementById('endpointPath').value = '';
                document.getElementById('endpointLogic').value = '';

            } catch (e) {
                writeToLog('error', `Erreur de syntaxe dans la logique JS : ${e.message}`);
            }
        }

        async function makeRequest() {
            const path = document.getElementById('requestPath').value;
            if (!path) {
                writeToLog('error', 'Le chemin de la requ√™te est requis.');
                return;
            }

            const btn = document.getElementById('requestBtn');
            btn.disabled = true;

            try {
                const data = await peerService.request(path);
                writeToLog('success', `Donn√©es re√ßues pour ${path}: ${JSON.stringify(data, null, 2)}`);
            } catch (e) {
                writeToLog('error', `√âchec de la requ√™te: ${e.message}`);
            } finally {
                btn.disabled = false;
            }
        }

    </script>
</body>
</html>
